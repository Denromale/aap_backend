{% extends "core/base.html" %}
{% load i18n %}

{% block title %}
    {% if read_only %}
        {% trans "Дані клієнта" %}
    {% elif edit %}
        {% trans "Редагувати клієнта" %}
    {% else %}
        {% trans "Додати клієнта" %}
    {% endif %}
{% endblock %}

{% block content %}
<h1>
    {% if read_only %}
        {% blocktrans with client_name=client.name %}
            Дані клієнта: {{ client_name }}
        {% endblocktrans %}
    {% elif edit %}
        {% blocktrans with client_name=client.name %}
            Редагувати клієнта: {{ client_name }}
        {% endblocktrans %}
    {% else %}
        {% trans "Додати клієнта" %}
    {% endif %}
</h1>

<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
        <div class="field-error">
            {{ form.non_field_errors }}
        </div>
    {% endif %}

    <h2>{% trans "Основні дані" %}</h2>

    <p class="{% if form.name.errors %}has-error{% endif %}">
        <label for="{{ form.name.id_for_label }}">
            <strong>
                {% trans "Найменування:" %}
                {% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
            </strong>
        </label><br>
        {{ form.name }}
        {% if form.name.errors %}
            <div class="field-error">{{ form.name.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.edrpou.errors %}has-error{% endif %}">
        <label for="{{ form.edrpou.id_for_label }}">
            <strong>
                {% trans "ЄДРПОУ:" %}
                {% if form.edrpou.field.required %}<span class="text-danger">*</span>{% endif %}
            </strong>
        </label><br>
        {{ form.edrpou }}
        {% if form.edrpou.errors %}
            <div class="field-error">{{ form.edrpou.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "Адреса (місцезнаходження)" %}</h2>

    <p class="{% if form.address_country.errors %}has-error{% endif %}">
        <label for="{{ form.address_country.id_for_label }}">
            {% trans "Країна:" %}
            {% if form.address_country.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.address_country }}
        {% if form.address_country.errors %}
            <div class="field-error">{{ form.address_country.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.address_city.errors %}has-error{% endif %}">
        <label for="{{ form.address_city.id_for_label }}">
            {% trans "Місто:" %}
            {% if form.address_city.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.address_city }}
        {% if form.address_city.errors %}
            <div class="field-error">{{ form.address_city.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.address_street.errors %}has-error{% endif %}">
        <label for="{{ form.address_street.id_for_label }}">
            {% trans "Вулиця:" %}
            {% if form.address_street.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.address_street }}
        {% if form.address_street.errors %}
            <div class="field-error">{{ form.address_street.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.address_building.errors %}has-error{% endif %}">
        <label for="{{ form.address_building.id_for_label }}">
            {% trans "Будинок/корпус:" %}
            {% if form.address_building.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.address_building }}
        {% if form.address_building.errors %}
            <div class="field-error">{{ form.address_building.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.address_office.errors %}has-error{% endif %}">
        <label for="{{ form.address_office.id_for_label }}">
            {% trans "Офіс:" %}
            {% if form.address_office.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.address_office }}
        {% if form.address_office.errors %}
            <div class="field-error">{{ form.address_office.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.address_zip.errors %}has-error{% endif %}">
        <label for="{{ form.address_zip.id_for_label }}">
            {% trans "Індекс:" %}
            {% if form.address_zip.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.address_zip }}
        {% if form.address_zip.errors %}
            <div class="field-error">{{ form.address_zip.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "КВЕД та ПСІ" %}</h2>

    <p class="{% if form.kved.errors %}has-error{% endif %}">
        <label for="{{ form.kved.id_for_label }}">
            {% trans "КВЕД:" %}
            {% if form.kved.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.kved }}
        {% if form.kved.errors %}
            <div class="field-error">{{ form.kved.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.poi.errors %}has-error{% endif %}">
        <label for="{{ form.poi.id_for_label }}">
            {% trans "ПСІ:" %}
        </label>
        {{ form.poi }}
        {% if form.poi.errors %}
            <div class="field-error">{{ form.poi.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "Реквізити договору" %}</h2>

    <p class="{% if form.requisites_number.errors %}has-error{% endif %}">
        <label for="{{ form.requisites_number.id_for_label }}">
            {% trans "№ договору/документа:" %}
            {% if form.requisites_number.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.requisites_number }}
        {% if form.requisites_number.errors %}
            <div class="field-error">{{ form.requisites_number.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.requisites_date.errors %}has-error{% endif %}">
        <label for="{{ form.requisites_date.id_for_label }}">
            {% trans "Дата договору/документа:" %}
            {% if form.requisites_date.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.requisites_date }}
        {% if form.requisites_date.errors %}
            <div class="field-error">{{ form.requisites_date.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.requisites_amount.errors %}has-error{% endif %}">
        <label for="{{ form.requisites_amount.id_for_label }}">
            {% trans "Сума:" %}
            {% if form.requisites_amount.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.requisites_amount }}
        {% if form.requisites_amount.errors %}
            <div class="field-error">{{ form.requisites_amount.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.requisites_vat.errors %}has-error{% endif %}">
        <label for="{{ form.requisites_vat.id_for_label }}">
            {% trans "ПДВ:" %}
            {% if form.requisites_vat.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.requisites_vat }}
        {% if form.requisites_vat.errors %}
            <div class="field-error">{{ form.requisites_vat.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.planned_hours.errors %}has-error{% endif %}">
        <label for="{{ form.planned_hours.id_for_label }}">
            {% trans "Робочі години (план):" %}
            {% if form.planned_hours.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.planned_hours }}
        {% if form.planned_hours.errors %}
            <div class="field-error">{{ form.planned_hours.errors }}</div>
        {% endif %}
    </p>

    <div class="mb-3">
        <label for="{{ form.contract_scan.id_for_label }}">Скан-копія договору *</label>
        {{ form.contract_scan }}
        {% if form.contract_scan.errors %}
            <div class="text-danger">{{ form.contract_scan.errors }}</div>
        {% endif %}
    </div>

    <h2>{% trans "Нагляд, ОПФ, обов'язковий аудит" %}</h2>

    <p class="{% if form.supervision_body.errors %}has-error{% endif %}">
        <label for="{{ form.supervision_body.id_for_label }}">
            {% trans "Орган нагляду:" %}
            {% if form.supervision_body.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.supervision_body }}
        {% if form.supervision_body.errors %}
            <div class="field-error">{{ form.supervision_body.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.legal_form.errors %}has-error{% endif %}">
        <label for="{{ form.legal_form.id_for_label }}">
            {% trans "Організаційно-правова форма:" %}
            {% if form.legal_form.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.legal_form }}
        {% if form.legal_form.errors %}
            <div class="field-error">{{ form.legal_form.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.mandatory_audit.errors %}has-error{% endif %}">
        <label for="{{ form.mandatory_audit.id_for_label }}">
            {% trans "Обов'язковий аудит (огляд):" %}
        </label>
        {{ form.mandatory_audit }}
        {% if form.mandatory_audit.errors %}
            <div class="field-error">{{ form.mandatory_audit.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "Період та строк" %}</h2>

    <p class="{% if form.reporting_period.errors %}has-error{% endif %}">
        <label for="{{ form.reporting_period.id_for_label }}">
            {% trans "Звітний період:" %}
            {% if form.reporting_period.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.reporting_period }}
        {% if form.reporting_period.errors %}
            <div class="field-error">{{ form.reporting_period.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.contract_deadline.errors %}has-error{% endif %}">
        <label for="{{ form.contract_deadline.id_for_label }}">
            {% trans "Кінцевий строк виконання договору:" %}
            {% if form.contract_deadline.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.contract_deadline }}
        {% if form.contract_deadline.errors %}
            <div class="field-error">{{ form.contract_deadline.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "Предмет завдання" %}</h2>

    <p class="{% if form.engagement_subject.errors %}has-error{% endif %}">
        <label for="{{ form.engagement_subject.id_for_label }}">
            {% trans "Предмет завдання:" %}
            {% if form.engagement_subject.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.engagement_subject }}
        {% if form.engagement_subject.errors %}
            <div class="field-error">{{ form.engagement_subject.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "Уповноважена особа клієнта" %}</h2>

    <p class="{% if form.authorized_person_name.errors %}has-error{% endif %}">
        <label for="{{ form.authorized_person_name.id_for_label }}">
            {% trans "ПІБ:" %}
            {% if form.authorized_person_name.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.authorized_person_name }}
        {% if form.authorized_person_name.errors %}
            <div class="field-error">{{ form.authorized_person_name.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.authorized_person_email.errors %}has-error{% endif %}">
        <label for="{{ form.authorized_person_email.id_for_label }}">
            Email:
            {% if form.authorized_person_email.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.authorized_person_email }}
        {% if form.authorized_person_email.errors %}
            <div class="field-error">{{ form.authorized_person_email.errors }}</div>
        {% endif %}
    </p>

    <h2>{% trans "Дані аудиторського звіту" %}</h2>

    <p class="{% if form.audit_report_number.errors %}has-error{% endif %}">
        <label for="{{ form.audit_report_number.id_for_label }}">
            {% trans "№ аудиторського звіту:" %}
        </label><br>
        {{ form.audit_report_number }}
        {% if form.audit_report_number.errors %}
            <div class="field-error">{{ form.audit_report_number.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.audit_report_date.errors %}has-error{% endif %}">
        <label for="{{ form.audit_report_date.id_for_label }}">
            {% trans "Дата аудиторського звіту:" %}
        </label><br>
        {{ form.audit_report_date }}
        {% if form.audit_report_date.errors %}
            <div class="field-error">{{ form.audit_report_date.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.audit_report_type.errors %}has-error{% endif %}">
        <label for="{{ form.audit_report_type.id_for_label }}">
            {% trans "Вид:" %}
        </label><br>
        {{ form.audit_report_type }}
        {% if form.audit_report_type.errors %}
            <div class="field-error">{{ form.audit_report_type.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.audit_report_paragraph.errors %}has-error{% endif %}">
        <label for="{{ form.audit_report_paragraph.id_for_label }}">
            {% trans "Параграф:" %}
        </label><br>
        {{ form.audit_report_paragraph }}
        {% if form.audit_report_paragraph.errors %}
            <div class="field-error">{{ form.audit_report_paragraph.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.supervision_notice_date.errors %}has-error{% endif %}">
        <label for="{{ form.supervision_notice_date.id_for_label }}">
            {% trans "Дата повідомлення до органу нагляду:" %}
        </label><br>
        {{ form.supervision_notice_date }}
        {% if form.supervision_notice_date.errors %}
            <div class="field-error">{{ form.supervision_notice_date.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.cw_controls_done.errors %}has-error{% endif %}">
        <label for="{{ form.cw_controls_done.id_for_label }}">
            {% trans "Контрольні процедури в CW виконані:" %}
        </label>
        {{ form.cw_controls_done }}
        {% if form.cw_controls_done.errors %}
            <div class="field-error">{{ form.cw_controls_done.errors }}</div>
        {% endif %}
    </p>

    <div class="mb-3" style="margin-top:12px;">
        <label for="{{ form.audit_report_scan.id_for_label }}">
            {% trans "Скан-копія аудиторського звіту" %}
        </label><br>
        {{ form.audit_report_scan }}
        {% if form.audit_report_scan.errors %}
            <div class="field-error">{{ form.audit_report_scan.errors }}</div>
        {% endif %}

        {% if client.audit_report_scan %}
            <div class="hint" style="margin-top:6px;">
                {% trans "Поточний файл:" %}
                <a href="{{ client.audit_report_scan.url }}" target="_blank">{% trans "Відкрити" %}</a>
            </div>
        {% endif %}
    </div>

    <h2>{% trans "Статус та команда" %}</h2>

    <p class="{% if form.status.errors %}has-error{% endif %}">
        <label for="{{ form.status.id_for_label }}">
            {% trans "Статус:" %}
            {% if form.status.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.status }}
        {% if form.status.errors %}
            <div class="field-error">{{ form.status.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.manager.errors %}has-error{% endif %}">
        <label for="{{ form.manager.id_for_label }}">
            {% trans "Менеджер:" %}
            {% if form.manager.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.manager }}
        {% if form.manager.errors %}
            <div class="field-error">{{ form.manager.errors }}</div>
        {% endif %}
    </p>

    <p class="{% if form.qa_manager.errors %}has-error{% endif %}">
        <label for="{{ form.qa_manager.id_for_label }}">
            {% trans "Менеджер КК:" %}
            {% if form.qa_manager.field.required %}<span class="text-danger">*</span>{% endif %}
        </label><br>
        {{ form.qa_manager }}
        {% if form.qa_manager.errors %}
            <div class="field-error">{{ form.qa_manager.errors }}</div>
        {% endif %}
    </p>

    <div class="hint" style="margin: 10px 0 16px 0; padding:10px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:8px;">
        {% trans "Інші ролі команди (аудитори/асистенти) формуються на кроці 1.5 «Формування команди та Етика»." %}
    </div>

    <br>
    {% if not read_only %}
        <button type="submit" class="btn btn-primary">
            {% trans "Зберегти" %}
        </button>
    {% endif %}

    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
        {% if read_only %}
            {% trans "Назад до списку" %}
        {% else %}
            {% trans "Скасувати" %}
        {% endif %}
    </a>

    {% if edit and user.is_superuser or edit and is_manager %}
        <button type="submit"
                class="btn btn-outline-primary"
                formaction="{% url 'client_complete' client.pk %}"
                formmethod="post"
                onclick="return confirm('Ви впевнені, що хочете завершити проєкт? Після цього він буде в Архіві.');">
            Завершити проєкт
        </button>
    {% endif %}
</form>
<script>
(function () {
  const numberEl = document.getElementById("id_requisites_number");
  const dateEl   = document.getElementById("id_requisites_date");

  if (!numberEl) return;

  let timer = null;
  let lastKey = "";

  function setVal(fieldId, value) {
    const el = document.getElementById(fieldId);
    if (!el) return;
    el.value = value ?? "";
    el.dispatchEvent(new Event("change", { bubbles: true }));
    el.dispatchEvent(new Event("input", { bubbles: true }));
  }

  async function runPrefill() {
    const num = (numberEl.value || "").trim();
    const date = dateEl ? (dateEl.value || "").trim() : "";

    if (!num || num.length < 2) return;

    const key = num + "|" + date;
    if (key === lastKey) return;
    lastKey = key;

    const params = new URLSearchParams({ requisites_number: num });
    if (date) params.set("requisites_date", date);

    const resp = await fetch("{% url 'client_prefill' %}?" + params.toString(), {
      headers: { "X-Requested-With": "fetch" }
    });

    if (!resp.ok) return;

    const json = await resp.json();
    if (!json.ok || !json.found) return;

    const d = json.data || {};

    // заполняем поля из формы (ids в Django: id_<fieldname>)
    setVal("id_name", d.name);
    setVal("id_edrpou", d.edrpou);

    setVal("id_address_country", d.address_country);
    setVal("id_address_city", d.address_city);
    setVal("id_address_street", d.address_street);
    setVal("id_address_building", d.address_building);
    setVal("id_address_office", d.address_office);
    setVal("id_address_zip", d.address_zip);

    setVal("id_kved", d.kved);
    // poi checkbox
    const poiEl = document.getElementById("id_poi");
    if (poiEl && typeof d.poi !== "undefined") {
      poiEl.checked = !!d.poi;
      poiEl.dispatchEvent(new Event("change", { bubbles: true }));
    }

    setVal("id_requisites_number", d.requisites_number);
    setVal("id_requisites_date", d.requisites_date);
    setVal("id_requisites_amount", d.requisites_amount);
    setVal("id_requisites_vat", d.requisites_vat);

    setVal("id_planned_hours", d.planned_hours);

    setVal("id_supervision_body", d.supervision_body);
    setVal("id_legal_form", d.legal_form);
    const mandatoryEl = document.getElementById("id_mandatory_audit");
    if (mandatoryEl && typeof d.mandatory_audit !== "undefined") {
      mandatoryEl.checked = !!d.mandatory_audit;
      mandatoryEl.dispatchEvent(new Event("change", { bubbles: true }));
    }

    setVal("id_reporting_period", d.reporting_period);
    setVal("id_contract_deadline", d.contract_deadline);

    // ВАЖНО: предмет завдання НЕ заполняем (по ТЗ пользователь корректирует его)
    // setVal("id_engagement_subject", d.engagement_subject);

    setVal("id_authorized_person_name", d.authorized_person_name);
    setVal("id_authorized_person_email", d.authorized_person_email);

    setVal("id_status", d.status);

    // Команду не трогаем (аудиторы/ассистенты disabled), но manager/qa_manager можно подтянуть:
    setVal("id_manager", d.manager);
    setVal("id_qa_manager", d.qa_manager);
  }

  function schedule() {
    clearTimeout(timer);
    timer = setTimeout(runPrefill, 350);
  }

  numberEl.addEventListener("input", schedule);
  if (dateEl) dateEl.addEventListener("change", schedule);
})();
</script>
{% endblock %}
