{% extends "core/base.html" %}
{% load i18n %}
{% load aap_extras %}
{% load static %}

{% block title %}
  КРОК {{ step.order }} – {{ step.title }}
{% endblock %}

{% block content %}

{# Верхний степпер 1–12 (кликабельный) #}
<div class="aap-stepper aap-stepper--top">
  <a class="aap-step aap-step--idle {% if step.order == 1 %}is-active{% endif %}" href="{% url 'audit_step' 1 %}">1</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 2 %}is-active{% endif %}" href="{% url 'audit_step' 2 %}">2</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 3 %}is-active{% endif %}" href="{% url 'audit_step' 3 %}">3</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 4 %}is-active{% endif %}" href="{% url 'audit_step' 4 %}">4</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 5 %}is-active{% endif %}" href="{% url 'audit_step' 5 %}">5</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 6 %}is-active{% endif %}" href="{% url 'audit_step' 6 %}">6</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 7 %}is-active{% endif %}" href="{% url 'audit_step' 7 %}">7</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 8 %}is-active{% endif %}" href="{% url 'audit_step' 8 %}">8</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 9 %}is-active{% endif %}" href="{% url 'audit_step' 9 %}">9</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 10 %}is-active{% endif %}" href="{% url 'audit_step' 10 %}">10</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 11 %}is-active{% endif %}" href="{% url 'audit_step' 11 %}">11</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 12 %}is-active{% endif %}" href="{% url 'audit_step' 12 %}">12</a>
</div>

<h2 class="audit-step-title">КРОК {{ step.order }} - {{ step.title }}</h2>

{% if step.purpose %}
<div class="step-inline">
  <span class="step-inline-label">Мета:</span>
  <span class="step-inline-body">{{ step.purpose|linebreaks }}</span>
</div>
{% endif %}

{% if step.documentation %}
<div class="step-inline">
  <span class="step-inline-label">Документування:</span>
  <span class="step-inline-body">{{ step.documentation|linebreaks }}</span>
</div>
{% endif %}

{% if step.procedure_description %}
<div class="step-inline">
  <span class="step-inline-label">Опис процедур:</span>
  <span class="step-inline-body">{{ step.procedure_description|linebreaks }}</span>
</div>
{% endif %}

{% if step.expected_result %}
<div class="step-inline step-inline--result">
  <span class="step-inline-label">Очікуваний результат:</span>
  <span class="step-inline-body">{{ step.expected_result|linebreaks }}</span>
</div>
{% endif %}

{% if not selected_client %}
  <p class="audit-hint">
    Спочатку оберіть проєкт на сторінці
    «<a href="{% url 'dashboard' %}">Призначені проєкти</a>».
  </p>
{% else %}

  {# Подшаги: степпер + панели #}
  <div class="aap-stepper aap-stepper--sub" id="subStepper">
    {% for s in substeps %}
      {% with sid=s.id|stringformat:"s" %}
      <div class="aap-step {{ substep_status_class|get_item:sid }} {% if forloop.first %}is-active{% endif %}"
           data-code="{{ s.id }}" role="button" tabindex="0">
        <span class="aap-step-num">{{ s.order }}</span>
        {% if substep_is_done|get_item:sid %}
          <span class="aap-step-check">✓</span>
        {% endif %}
      </div>
      {% endwith %}

      {% if not forloop.last %}<div class="aap-step-line"></div>{% endif %}
    {% endfor %}
  </div>

  <div class="aap-step-panels" id="subPanels">
    {% for s in substeps %}
      <div class="aap-step-panel {% if forloop.first %}is-open{% endif %}" id="panel-{{ s.id }}">

        <h4 style="margin:0 0 8px;">{{ step.order }}.{{ s.order }} {{ s.title }}</h4>

        {% if s.purpose %}
          <div class="step-inline">
            <span class="step-inline-label"><b>Мета:</b></span>
            <span class="step-inline-body">{{ s.purpose|linebreaks }}</span>
          </div>
        {% endif %}

        {% if s.documentation %}
          <div class="step-inline">
            <span class="step-inline-label"><b>Документування:</b></span>
            <span class="step-inline-body">{{ s.documentation|linebreaks }}</span>
          </div>
        {% endif %}

        {% if s.procedure_description %}
          <div class="step-inline">
            <span class="step-inline-label"><b>Опис процедур:</b></span>
            <span class="step-inline-body">{{ s.procedure_description|linebreaks }}</span>
          </div>
        {% endif %}

        {% if s.expected_result %}
          <div class="step-inline step-inline--result">
            <span class="step-inline-label"><b>Очікуваний результат:</b></span>
            <span class="step-inline-body">{{ s.expected_result|linebreaks }}</span>
          </div>
        {% endif %}

        {# ===== Step 1.5: форма команди (селект короткий + кнопка справа) ===== #}
        {# ===== Step 1.5: форма команди (ТОЛЬКО ТУТ и ТОЛЬКО ВНИЗУ) ===== #}
        {% if step.order == 1 and s.order == 5 %}
          <hr style="margin:14px 0;">
          <h4 style="margin:0 0 10px;">Формування команди</h4>
        
          {% if not can_view_step15 %}
            <div class="audit-hint">
              Немає доступу до кроку 1.5.
            </div>
          {% else %}
            <form method="post" novalidate class="team-form">
              {% csrf_token %}
              <input type="hidden" name="form_name" value="step15_team">
              <input type="hidden" name="substep_id" value="{{ s.id }}">
              {% if team_form.non_field_errors %}
                <div class="field-error">{{ team_form.non_field_errors }}</div>
              {% endif %}
        
              {# ===== РЯДОК: Менеджер ===== #}
              <div class="team-row">
                <div class="team-role">
                  Менеджер <span class="team-required">*</span>
                  {% if team_form.manager.errors %}
                    <div class="field-error">{{ team_form.manager.errors }}</div>
                  {% endif %}
                </div>
        
                <div class="team-select-col">
                  {{ team_form.manager }}
                </div>
        
                <div class="team-action-col">
                  {# кнопка справа показывается только если выбран пользователь и это текущий user #}
                  {% if team_form.manager.value and team_form.manager.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Менеджер КК ===== #}
              <div class="team-row">
                <div class="team-role">
                  Менеджер КК <span class="team-required">*</span>
                  {% if team_form.qa_manager.errors %}
                    <div class="field-error">{{ team_form.qa_manager.errors }}</div>
                  {% endif %}
                </div>
        
                <div class="team-select-col">
                  {{ team_form.qa_manager }}
                </div>
        
                <div class="team-action-col">
                  {% if team_form.qa_manager.value and team_form.qa_manager.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Аудитор 1 ===== #}
              <div class="team-row">
                <div class="team-role">Аудитор 1</div>
                <div class="team-select-col">{{ team_form.auditor }}</div>
                <div class="team-action-col">
                  {% if team_form.auditor.value and team_form.auditor.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Аудитор 2 ===== #}
              <div class="team-row">
                <div class="team-role">Аудитор 2</div>
                <div class="team-select-col">{{ team_form.auditor2 }}</div>
                <div class="team-action-col">
                  {% if team_form.auditor2.value and team_form.auditor2.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Аудитор 3 ===== #}
              <div class="team-row">
                <div class="team-role">Аудитор 3</div>
                <div class="team-select-col">{{ team_form.auditor3 }}</div>
                <div class="team-action-col">
                  {% if team_form.auditor3.value and team_form.auditor3.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 1 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 1</div>
                <div class="team-select-col">{{ team_form.assistant }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant.value and team_form.assistant.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 2 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 2</div>
                <div class="team-select-col">{{ team_form.assistant2 }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant2.value and team_form.assistant2.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 3 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 3</div>
                <div class="team-select-col">{{ team_form.assistant3 }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant3.value and team_form.assistant3.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 4 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 4</div>
                <div class="team-select-col">{{ team_form.assistant4 }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant4.value and team_form.assistant4.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                  <button type="submit"
                         class="btn btn-secondary team-right-btn"
                         formaction="{% url 'step15_generate_independence' %}"
                         formmethod="post">
                      Анкета незалежності
                  </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== КНОПКИ ВНИЗУ (друг под другом как на твоём 1-м фото) ===== #}
              <div class="team-bottom-actions">
                {% if can_manage_step15 %}
                  <button type="submit" class="btn btn-primary" name="action" value="save_team">
                    Зберегти команду
                  </button>
                {% else %}
                  <div class="audit-hint" style="margin-bottom:8px;">
                    Ви можете переглядати команду, але не маєте прав її змінювати.
                  </div>
                {% endif %}

                {# генерация разрешена члену команды #}
                <button type="submit" class="btn btn-secondary" name="action" value="generate_request">
                  Розпорядження на призначення команди
                </button>

                <button type="submit" class="btn btn-secondary" name="action" value="generate_remembrance">
                  Памʼятка
                </button>
              </div>

              
              
              
            </form>
          {% endif %}
        {% endif %}
        

        {# ===== ДІЇ РІВНЯ ПІДКРОКУ (кнопки внизу підкроку) ===== #}
        {% with actions_list=substep_actions_map|get_item:s.id %}
           {% for a in actions_list %}
             <div class="audit-action">
               <form method="post" style="display:inline;">
                 {% csrf_token %}
                 <input type="hidden" name="form_name" value="substep_action">
                 <input type="hidden" name="substep_id" value="{{ s.id }}">
                 <input type="hidden" name="action_id" value="{{ a.id }}">

                 <button type="submit" class="btn btn-primary audit-action__btn">
                   {{ a.label }}
                 </button>
               </form>

               {% if a.description %}
                 <div class="audit-action__desc">{{ a.description }}</div>
               {% endif %}
             </div>
           {% endfor %}

        {% endwith %}

        {# ===== ДОКУМЕНТИ: завжди останній блок підкроку ===== #}
        <div class="audit-docs" style="margin-top: 14px;">
          <h4 class="audit-docs__title">Додаткові документи підкроку</h4>

          {% with sid=s.id|stringformat:"s" %}
            {% with file_list=substep_files_map|get_item:sid %}
              {% if file_list %}
                <div class="audit-docs__list" style="margin:8px 0 12px;">
                  {% for f in file_list %}
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
                      <a href="{{ f.file.url }}" target="_blank" rel="noopener">
                        {{ f.file.name }}
                      </a>
                      <form method="post" action="{% url 'procedure_file_delete' f.id %}" style="margin:0;">
                        {% csrf_token %}
                        <button class="btn btn-secondary" type="submit">Видалити</button>
                      </form>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
          {% endwith %}

          <form method="post" action="{% url 'procedure_file_upload' %}"
                enctype="multipart/form-data" class="js-substep-upload">
            {% csrf_token %}
            <input type="hidden" name="substep_id" value="{{ s.id }}">
            <input type="file" name="file" required>
            <button type="submit" class="btn btn-primary">Завантажити</button>
          </form>
                  {# ===== AAP: Manual done toggle ("Виконано") ===== #}
        {% with sid=s.id|stringformat:"s" %}
          {% if can_toggle_done %}
            <div class="substep-done-box">
              {% if substep_is_done|get_item:sid %}
                <div class="substep-done-meta">
                  {% with n=completed_by_label|get_item:sid %}
                    {% if n %}<div><b>Виконав:</b> {{ n }}</div>{% endif %}
                  {% endwith %}
                  {% with dt=completed_at_label|get_item:sid %}
                    {% if dt %}<div><b>Коли:</b> {{ dt }}</div>{% endif %}
                  {% endwith %}
                </div>
              {% endif %}

              <form method="post" action="{% url 'substep_status_toggle' %}" class="substep-done-form">
                {% csrf_token %}
                <input type="hidden" name="substep_id" value="{{ s.id }}">
                <button type="submit" class="btn btn-secondary">
                  {% if substep_is_done|get_item:sid %}Скасувати виконано{% else %}Виконано{% endif %}
                </button>
              </form>
            </div>
          {% endif %}
        {% endwith %}

        </div>         
      </div>
    {% endfor %}
  </div>

<script src="{% static 'core/audit_stepper.js' %}"></script>
<script src="{% static 'core/audit_upload.js' %}"></script>


{% endif %}
{% endblock %}
