{% extends "core/base.html" %}
{% load i18n %}
{% load aap_extras %}

{% block title %}
  КРОК {{ step.order }} – {{ step.title }}
{% endblock %}

{% block content %}

{# Верхний степпер 1–12 (кликабельный) #}
<div class="aap-stepper aap-stepper--top">
  <a class="aap-step aap-step--idle {% if step.order == 1 %}is-active{% endif %}" href="{% url 'audit_step' 1 %}">1</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 2 %}is-active{% endif %}" href="{% url 'audit_step' 2 %}">2</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 3 %}is-active{% endif %}" href="{% url 'audit_step' 3 %}">3</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 4 %}is-active{% endif %}" href="{% url 'audit_step' 4 %}">4</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 5 %}is-active{% endif %}" href="{% url 'audit_step' 5 %}">5</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 6 %}is-active{% endif %}" href="{% url 'audit_step' 6 %}">6</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 7 %}is-active{% endif %}" href="{% url 'audit_step' 7 %}">7</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 8 %}is-active{% endif %}" href="{% url 'audit_step' 8 %}">8</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 9 %}is-active{% endif %}" href="{% url 'audit_step' 9 %}">9</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 10 %}is-active{% endif %}" href="{% url 'audit_step' 10 %}">10</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 11 %}is-active{% endif %}" href="{% url 'audit_step' 11 %}">11</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 12 %}is-active{% endif %}" href="{% url 'audit_step' 12 %}">12</a>
</div>

<h2 class="audit-step-title">КРОК {{ step.order }} - {{ step.title }}</h2>

{% if step.purpose %}
<div class="step-inline">
  <span class="step-inline-label">Мета:</span>
  <span class="step-inline-body">{{ step.purpose|linebreaks }}</span>
</div>
{% endif %}

{% if step.documentation %}
<div class="step-inline">
  <span class="step-inline-label">Документування:</span>
  <span class="step-inline-body">{{ step.documentation|linebreaks }}</span>
</div>
{% endif %}

{% if step.procedure_description %}
<div class="step-inline">
  <span class="step-inline-label">Опис процедур:</span>
  <span class="step-inline-body">{{ step.procedure_description|linebreaks }}</span>
</div>
{% endif %}

{% if step.expected_result %}
<div class="step-inline step-inline--result">
  <span class="step-inline-label">Очікуваний результат:</span>
  <span class="step-inline-body">{{ step.expected_result|linebreaks }}</span>
</div>
{% endif %}

{% if not selected_client %}
  <p class="audit-hint">
    Спочатку оберіть проєкт на сторінці
    «<a href="{% url 'dashboard' %}">Призначені проєкти</a>».
  </p>
{% else %}

  {# Подшаги: степпер + панели #}
  <div class="aap-stepper aap-stepper--sub" id="subStepper">
    {% for s in substeps %}
      <div class="aap-step aap-step--idle {% if forloop.first %}is-active{% endif %}"
           data-code="{{ s.id }}" role="button" tabindex="0">
        {{ s.order }}
      </div>
      {% if not forloop.last %}<div class="aap-step-line"></div>{% endif %}
    {% endfor %}
  </div>

  <div class="aap-step-panels" id="subPanels">
    {% for s in substeps %}
      <div class="aap-step-panel {% if forloop.first %}is-open{% endif %}" id="panel-{{ s.id }}">

        <h4 style="margin:0 0 8px;">{{ step.order }}.{{ s.order }} {{ s.title }}</h4>

        {% if s.purpose %}
          <div class="step-inline">
            <span class="step-inline-label"><b>Мета:</b></span>
            <span class="step-inline-body">{{ s.purpose|linebreaks }}</span>
          </div>
        {% endif %}

        {% if s.documentation %}
          <div class="step-inline">
            <span class="step-inline-label"><b>Документування:</b></span>
            <span class="step-inline-body">{{ s.documentation|linebreaks }}</span>
          </div>
        {% endif %}

        {% if s.procedure_description %}
          <div class="step-inline">
            <span class="step-inline-label"><b>Опис процедур:</b></span>
            <span class="step-inline-body">{{ s.procedure_description|linebreaks }}</span>
          </div>
        {% endif %}

        {% if s.expected_result %}
          <div class="step-inline step-inline--result">
            <span class="step-inline-label"><b>Очікуваний результат:</b></span>
            <span class="step-inline-body">{{ s.expected_result|linebreaks }}</span>
          </div>
        {% endif %}

        {# ===== Step 1.5: форма команди (селект короткий + кнопка справа) ===== #}
        {# ===== Step 1.5: форма команди (ТОЛЬКО ТУТ и ТОЛЬКО ВНИЗУ) ===== #}
        {% if step.order == 1 and s.order == 5 %}
          <hr style="margin:14px 0;">
          <h4 style="margin:0 0 10px;">Формування команди</h4>
        
          {% if not can_manage_step15 %}
            <div class="audit-hint">
              Немає прав змінювати команду на кроці 1.5.
            </div>
          {% else %}
            <form method="post" novalidate class="team-form">
              {% csrf_token %}
              <input type="hidden" name="form_name" value="step15_team">
        
              {% if team_form.non_field_errors %}
                <div class="field-error">{{ team_form.non_field_errors }}</div>
              {% endif %}
        
              {# ===== РЯДОК: Менеджер ===== #}
              <div class="team-row">
                <div class="team-role">
                  Менеджер <span class="team-required">*</span>
                  {% if team_form.manager.errors %}
                    <div class="field-error">{{ team_form.manager.errors }}</div>
                  {% endif %}
                </div>
        
                <div class="team-select-col">
                  {{ team_form.manager }}
                </div>
        
                <div class="team-action-col">
                  {# кнопка справа показывается только если выбран пользователь и это текущий user #}
                  {% if team_form.manager.value and team_form.manager.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Менеджер КК ===== #}
              <div class="team-row">
                <div class="team-role">
                  Менеджер КК <span class="team-required">*</span>
                  {% if team_form.qa_manager.errors %}
                    <div class="field-error">{{ team_form.qa_manager.errors }}</div>
                  {% endif %}
                </div>
        
                <div class="team-select-col">
                  {{ team_form.qa_manager }}
                </div>
        
                <div class="team-action-col">
                  {% if team_form.qa_manager.value and team_form.qa_manager.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Аудитор 1 ===== #}
              <div class="team-row">
                <div class="team-role">Аудитор 1</div>
                <div class="team-select-col">{{ team_form.auditor }}</div>
                <div class="team-action-col">
                  {% if team_form.auditor.value and team_form.auditor.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Аудитор 2 ===== #}
              <div class="team-row">
                <div class="team-role">Аудитор 2</div>
                <div class="team-select-col">{{ team_form.auditor2 }}</div>
                <div class="team-action-col">
                  {% if team_form.auditor2.value and team_form.auditor2.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Аудитор 3 ===== #}
              <div class="team-row">
                <div class="team-role">Аудитор 3</div>
                <div class="team-select-col">{{ team_form.auditor3 }}</div>
                <div class="team-action-col">
                  {% if team_form.auditor3.value and team_form.auditor3.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 1 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 1</div>
                <div class="team-select-col">{{ team_form.assistant }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant.value and team_form.assistant.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 2 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 2</div>
                <div class="team-select-col">{{ team_form.assistant2 }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant2.value and team_form.assistant2.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 3 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 3</div>
                <div class="team-select-col">{{ team_form.assistant3 }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant3.value and team_form.assistant3.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== РЯДОК: Асистент 4 ===== #}
              <div class="team-row">
                <div class="team-role">Асистент 4</div>
                <div class="team-select-col">{{ team_form.assistant4 }}</div>
                <div class="team-action-col">
                  {% if team_form.assistant4.value and team_form.assistant4.value|stringformat:"s" == request.user.id|stringformat:"s" %}
                    <button type="button" class="btn btn-secondary team-right-btn">
                      Анкета незалежності
                    </button>
                  {% endif %}
                </div>
              </div>
        
              {# ===== КНОПКИ ВНИЗУ (друг под другом как на твоём 1-м фото) ===== #}
              <div class="team-bottom-actions">
                <button type="submit" class="btn btn-primary" name="action" value="save_team">
                  Зберегти команду
                </button>
        
                <button type="submit" class="btn btn-secondary" name="action" value="generate_request">
                  Розпорядження на призначення команди
                </button>
        
                {# "Памʼятка" — пока как UI-кнопка. Потом привяжем к действию/документу #}
                <button type="button" class="btn btn-secondary">
                  Памʼятка
                </button>
              </div>
            </form>
          {% endif %}
        {% endif %}
        

        {# ===== ДІЇ РІВНЯ ПІДКРОКУ (кнопки внизу підкроку) ===== #}
        {% with actions_list=substep_actions_map|get_item:s.id %}
          {% if actions_list %}
            <div class="audit-actions" style="margin-top: 14px;">
              <h4 class="audit-actions__title">Дії для підкроку</h4>
              <div class="audit-actions__list">
                {% for a in actions_list %}
                  <div class="audit-action">
                    <button type="button" class="btn btn-primary audit-action__btn" disabled title="Поки що без виконання">
                      {{ a.label }}
                    </button>
                    {% if a.description %}
                      <div class="audit-action__desc">{{ a.description }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endwith %}

        {# ===== ДОКУМЕНТИ: завжди останній блок підкроку ===== #}
        <div class="audit-docs" style="margin-top: 14px;">
          <h4 class="audit-docs__title">Додаткові документи підкроку</h4>

          <div class="audit-actions__note" style="margin-top:6px;">
            Завантаження з «Бази документів» тимчасово вимкнено (інакше буде 403).
            Документи додаються через відповідні дії/кнопки цього кроку.
          </div>

          <form class="audit-docs__form" style="opacity:.6; pointer-events:none;">
            <input type="file" name="file" disabled>
            <button type="button" class="btn btn-secondary" disabled>Додати документ</button>
          </form>
        </div>

      </div>
    {% endfor %}
  </div>

  <script>
  (function () {
    const stepper = document.getElementById('subStepper');
    if (!stepper) return;

    const steps = stepper.querySelectorAll('.aap-step');
    const panels = document.querySelectorAll('.aap-step-panel');

    function openPanel(code) {
      steps.forEach(s => s.classList.remove('is-active'));
      panels.forEach(p => p.classList.remove('is-open'));

      const activeStep = stepper.querySelector(`.aap-step[data-code="${code}"]`);
      const activePanel = document.getElementById(`panel-${code}`);

      if (activeStep) activeStep.classList.add('is-active');
      if (activePanel) activePanel.classList.add('is-open');
    }

    steps.forEach(s => {
      s.addEventListener('click', () => openPanel(s.dataset.code));
      s.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') openPanel(s.dataset.code);
      });
    });

    const first = steps[0] ? steps[0].dataset.code : null;
    if (first) openPanel(first);
  })();
  </script>

{% endif %}
{% endblock %}
