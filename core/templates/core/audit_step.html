{% extends "core/base.html" %}
{% load i18n %}

{% block title %}
  КРОК {{ step.order }} – {{ step.title }}
{% endblock %}

{% block content %}

{# Верхний степпер 1–12 (кликабельный) #}
<div class="aap-stepper">
  <a class="aap-step aap-step--idle {% if step.order == 1 %}is-active{% endif %}" href="{% url 'audit_step' 1 %}">1</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 2 %}is-active{% endif %}" href="{% url 'audit_step' 2 %}">2</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 3 %}is-active{% endif %}" href="{% url 'audit_step' 3 %}">3</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 4 %}is-active{% endif %}" href="{% url 'audit_step' 4 %}">4</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 5 %}is-active{% endif %}" href="{% url 'audit_step' 5 %}">5</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 6 %}is-active{% endif %}" href="{% url 'audit_step' 6 %}">6</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 7 %}is-active{% endif %}" href="{% url 'audit_step' 7 %}">7</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 8 %}is-active{% endif %}" href="{% url 'audit_step' 8 %}">8</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 9 %}is-active{% endif %}" href="{% url 'audit_step' 9 %}">9</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 10 %}is-active{% endif %}" href="{% url 'audit_step' 10 %}">10</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 11 %}is-active{% endif %}" href="{% url 'audit_step' 11 %}">11</a>
  <div class="aap-step-line"></div>
  <a class="aap-step aap-step--idle {% if step.order == 12 %}is-active{% endif %}" href="{% url 'audit_step' 12 %}">12</a>
</div>

<h2>КРОК {{ step.order }} - {{ step.title }}</h2>

{% if step.purpose %}
  <p class="page-subtitle">
    <b>Мета:</b> {{ step.purpose|linebreaksbr }}
  </p>
{% endif %}

{% if step.documentation %}
  <p class="page-subtitle">
    <b>Документування:</b> {{ step.documentation|linebreaksbr }}
  </p>
{% endif %}

{% if step.procedure_description %}
  <p class="page-subtitle">
    <b>Опис процедур:</b> {{ step.procedure_description|linebreaksbr }}
  </p>
{% endif %}

{% if step.expected_result %}
  <p class="page-subtitle">
    <b>Очікуваний результат:</b> {{ step.expected_result|linebreaksbr }}
  </p>
{% endif %}

{% if selected_client %}
  
{% else %}
  <p>
    Спочатку оберіть проєкт на сторінці
    «<a href="{% url 'dashboard' %}">Призначені проєкти</a>».
  </p>
{% endif %}



{# Подшаги НЕ списком: делаем подшаг-степпер + панели как в step-1 #}
<div class="aap-stepper" id="subStepper" style="margin-top: 10px;">
  {% for s in substeps %}
    <div class="aap-step aap-step--idle {% if forloop.first %}is-active{% endif %}"
         data-code="{{ s.id }}" role="button" tabindex="0">
      {{ s.order }}
    </div>

    {% if not forloop.last %}
      <div class="aap-step-line"></div>
    {% endif %}
  {% endfor %}
</div>

<div class="aap-step-panels" id="subPanels">
  {% for s in substeps %}
    <div class="aap-step-panel {% if forloop.first %}is-open{% endif %}" id="panel-{{ s.id }}">
      <h4 style="margin:0 0 8px;">{{ step.order }}.{{ s.order }} {{ s.title }}</h4>

      {% if s.procedure_description %}
        <p style="margin:0 0 12px; color:#6b7280;">{{ s.procedure_description|linebreaksbr }}</p>
      {% endif %}

      {% if s.expected_result %}
        <div class="card" style="padding:12px;">
          <b>Очікуваний результат:</b> {{ s.expected_result|linebreaksbr }}
        </div>
      {% endif %}

      {# (следующий шаг) сюда добавим:
         - кнопки действий подшага
         - кнопку "Добавить документ" + список документов подшага
      #}
    </div>
  {% endfor %}
</div>
{# Кнопки-действия шага (пока только отображение) #}
{% with actions=step.actions.all %}
  {% if actions %}
    <div style="margin: 14px 0 18px;">
      <h4 style="margin:0 0 10px;">Дії для кроку</h4>

      <div style="display:flex; flex-direction:column; gap:10px;">
        {% for a in actions %}
          {% if a.enabled and a.scope == "step" %}
            <div style="display:flex; gap:12px; align-items:flex-start;">
              <button type="button" class="btn btn-primary" style="min-width: 220px;">
                {{ a.label }}
              </button>
              <div style="color:#6b7280; padding-top:6px;">
                {{ a.description }}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div style="margin-top:8px; color:#6b7280; font-size:12px;">
        Примітка: виконання кнопок (POST + перевірка ролей) підключимо наступним кроком. Зараз це лише відображення з адмінки.
      </div>
    </div>
  {% endif %}
{% endwith %}
{% if selected_client %}
  <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
    <h4 style="margin:0 0 10px;">Документи кроку</h4>

    <form method="post" enctype="multipart/form-data"
          action="{% url 'documents' %}?client_id={{ selected_client.id }}"
          style="display:flex; gap:10px; align-items:center;">
      {% csrf_token %}

      <input type="hidden" name="action" value="upload">
      <input type="hidden" name="doc_type" value="procedure">
      <input type="hidden" name="label" value="Step {{ step.order }} / Крок {{ step.order }}">

      <input type="file" name="file" required>

      <button type="submit" class="btn btn-secondary">
        Додати документ
      </button>
    </form>
  </div>
{% endif %}

<script>
(function () {
  const stepper = document.getElementById('subStepper');
  if (!stepper) return;

  const steps = stepper.querySelectorAll('.aap-step');
  const panels = document.querySelectorAll('.aap-step-panel');

  function openPanel(code) {
    steps.forEach(s => s.classList.remove('is-active'));
    panels.forEach(p => p.classList.remove('is-open'));

    const activeStep = stepper.querySelector(`.aap-step[data-code="${code}"]`);
    const activePanel = document.getElementById(`panel-${code}`);

    if (activeStep) activeStep.classList.add('is-active');
    if (activePanel) activePanel.classList.add('is-open');
  }

  steps.forEach(s => {
    s.addEventListener('click', () => openPanel(s.dataset.code));
    s.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') openPanel(s.dataset.code);
    });
  });

  const first = steps[0] ? steps[0].dataset.code : null;
  if (first) openPanel(first);
})();
</script>

{% endblock %}
