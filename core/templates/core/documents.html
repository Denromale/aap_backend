{% extends "core/base.html" %}

{% block title %}База документів{% endblock %}

{% block content %}
<h1>База документів</h1>

{% if not selected_client %}

    <p>
        Спочатку оберіть проєкт на сторінці
        <a href="{% url 'dashboard' %}">«Призначені проєкти»</a>.
    </p>

{% else %}

<div style="margin-bottom: 20px; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
    <p style="margin: 0 0 4px 0;">
        <strong>Клієнт:</strong> {{ selected_client.name }}
    </p>
    <p style="margin: 0 0 4px 0;">
        <strong>Звітний період:</strong> {{ selected_client.reporting_period }}
        &nbsp;&nbsp;
        <strong>№ договору:</strong> {{ selected_client.requisites_number }}
    </p>
    <p style="margin: 0;">
        <strong>Предмет завдання:</strong>
        {{ selected_client.get_engagement_subject_display|default:selected_client.engagement_subject }}
    </p>
</div>

    <!-- КНОПКА ПОКАЗАТИ/ПРИХОВАТИ БЛОК ЗАВАНТАЖЕННЯ -->
    <button type="button"
            onclick="toggleUploadBlock()"
            style="margin: 15px 0; padding: 6px 12px; border-radius: 4px; border: none; background: #1e88e5; color: #fff; cursor: pointer;">
        Додати документ
    </button>

    <!-- БЛОК ЗАВАНТАЖЕННЯ (ПО УМОВЧАННЮ СХОВАНИЙ) -->
    <div id="upload-block"
         style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">

        <h3>Завантажити новий документ</h3>

        <form method="post"
              enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload">

            <div style="margin-bottom: 10px;">
                <label><strong>Файл:</strong></label><br>
                <input type="file" name="file">
            </div>

            <div style="margin-bottom: 10px;">
                <label><strong>Тип документа:</strong></label><br>
                <select name="doc_type">
                    <option value="">---------</option>
                    <option value="charter">Установчий документ</option>
                    <option value="request">Запит / лист</option>
                    <option value="agreement">Договір</option>
                    <option value="other">Інше</option>
                </select>
            </div>

            <div style="margin-bottom: 10px;">
                <label><strong>Мітка / примітка:</strong></label><br>
                <input type="text"
                       name="label"
                       style="width: 100%;"
                       placeholder="Напр.: установчий документ, додатковий запит тощо">
            </div>

            <button type="submit"
                    style="padding: 6px 12px; border-radius: 4px; border: none; background: #1e88e5; color: #fff; cursor: pointer;">
                Завантажити
            </button>
        </form>
    </div>

    <h3 style="margin-top: 25px;">Документи клієнта</h3>

    {% if documents %}
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 6px;">Назва</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Тип</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Мітка</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Завантажено</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Користувач</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Дія</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr>
                    <!-- 1. Назва та посилання на файл -->
                    <td style="border: 1px solid #ddd; padding: 6px;">
                        <a href="{{ doc.file.url }}" target="_blank">
                            {{ doc.original_name }}
                        </a>
                    </td>

                    <!-- 2. Форма оновлення / видалення -->
                    <form method="post" action="{% url 'document_update_type' doc.id %}">
                        {% csrf_token %}

                        <!-- Тип документа -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            <select name="doc_type">
                                <option value="">---------</option>
                                {% for code, label in doc_type_choices %}
                                    <option value="{{ code }}"
                                            {% if doc.doc_type == code %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>

                        <!-- Мітка -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            <input type="text"
                                   name="custom_label"
                                   value="{{ doc.custom_label|default:'' }}"
                                   style="width: 100%;">
                        </td>

                        <!-- Дата -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            {{ doc.created_at|date:"d.m.Y H:i" }}
                        </td>

                        <!-- Користувач -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username|default:"" }}
                        </td>

                        <!-- Дві кнопки -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            <button type="submit"
                                    style="padding: 4px 8px; border-radius: 4px; border: none;
                                           background: #1e88e5; color: #fff; cursor: pointer; margin-right: 6px;">
                                Зберегти
                            </button>

                            <button type="submit"
                                    formaction="{% url 'document_delete' doc.id %}"
                                    onclick="return confirm('Видалити документ?');"
                                    style="padding: 4px 8px; border-radius: 4px; border: none;
                                           background: #e53935; color: #fff; cursor: pointer;">
                                Видалити
                            </button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Документів для цього клієнта поки немає.</p>
    {% endif %}

{% endif %}

<script>
    function toggleUploadBlock() {
        const block = document.getElementById('upload-block');
        if (!block) return;
        if (block.style.display === 'none' || block.style.display === '') {
            block.style.display = 'block';
        } else {
            block.style.display = 'none';
        }
    }
</script>
{% endblock %}
