{% extends "core/base.html" %}

{% block title %}База документів{% endblock %}

{% block content %}
<h1>База документів</h1>

{% if not selected_client %}

    <p>
        Спочатку оберіть проєкт на сторінці
        <a href="{% url 'dashboard' %}">«Призначені проєкти»</a>.
    </p>

{% else %}
  

    <h3 style="margin-top: 25px;">Документи клієнта</h3>

    {% if documents %}
       <div style="display:flex; gap:10px; margin: 10px 0;">
        <button type="button" id="btn-download-zip"
                style="padding:6px 12px; border-radius:4px; border:none; background:#1e88e5; color:#fff; cursor:pointer;">
          Завантажити
        </button>
         <form id="download-zip-form"
           method="post"
           action="{% url 'documents_download_zip' %}"
           style="display:none;">
          {% csrf_token %}
          <input type="hidden" name="client_id" value="{{ selected_client.id|default:'' }}">
          <input type="hidden" name="doc_ids" id="download-doc-ids" value="">
         </form>
       </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 6px; width: 36px; text-align:center;">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Назва</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Тип</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Мітка</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Завантажено</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Ініціатор</th>
                    <th style="border: 1px solid #ddd; padding: 6px;">Дія</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr>
                    <td style="border: 1px solid #ddd; padding: 6px; text-align:center;">
                        <input type="checkbox" class="doc-check" value="{{ doc.id }}">
                    </td>
                    <!-- 1. Назва та посилання на файл -->
                    <td style="border: 1px solid #ddd; padding: 6px;">
                        <a href="{{ doc.file.url }}" target="_blank">
                            {{ doc.original_name }}
                        </a>
                    </td>

                    <!-- 2. Форма оновлення / видалення -->
                    <form method="post" action="{% url 'document_update_type' doc.id %}">
                        {% csrf_token %}

                        <!-- Тип документа -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            <select name="doc_type">
                                <option value="">---------</option>
                                {% for code, label in doc_type_choices %}
                                    <option value="{{ code }}"
                                            {% if doc.doc_type == code %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>

                        <!-- Мітка -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            <input type="text"
                                   name="custom_label"
                                   value="{{ doc.custom_label|default:'' }}"
                                   style="width: 100%;">
                        </td>

                        <!-- Дата -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            {{ doc.created_at|date:"d.m.Y H:i" }}
                        </td>

                        <!-- Користувач -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username|default:"" }}
                        </td>

                        <!-- Дві кнопки -->
                        <td style="border: 1px solid #ddd; padding: 6px;">
                            <button type="submit"
                                    style="padding: 4px 8px; border-radius: 4px; border: none;
                                           background: #1e88e5; color: #fff; cursor: pointer; margin-right: 6px;">
                                Зберегти
                            </button>

                            <button type="submit"
                                    formaction="{% url 'document_delete' doc.id %}"
                                    onclick="return confirm('Видалити документ?');"
                                    style="padding: 4px 8px; border-radius: 4px; border: none;
                                           background: #e53935; color: #fff; cursor: pointer;">
                                Видалити
                            </button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Документів для цього клієнта поки немає.</p>
    {% endif %}

{% endif %}

<script>
    function toggleUploadBlock() {
        const block = document.getElementById('upload-block');
        if (!block) return;
        if (block.style.display === 'none' || block.style.display === '') {
            block.style.display = 'block';
        } else {
            block.style.display = 'none';
        }
    }
</script>
<script>
    function getSelectedDocIds() {
      return Array.from(document.querySelectorAll(".doc-check:checked")).map(x => x.value);
    }
  
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
  
    function getFilenameFromContentDisposition(cd) {
      if (!cd) return null;
  
      // filename*=UTF-8''...
      const mStar = cd.match(/filename\*\s*=\s*UTF-8''([^;]+)/i);
      if (mStar) return decodeURIComponent(mStar[1]);
  
      // filename="..."
      const m = cd.match(/filename\s*=\s*"([^"]+)"/i);
      if (m) return m[1];
  
      // filename=...
      const m2 = cd.match(/filename\s*=\s*([^;]+)/i);
      if (m2) return m2[1].trim();
  
      return null;
    }
  
    document.getElementById("btn-download-zip")?.addEventListener("click", async () => {
      const ids = getSelectedDocIds();
      if (!ids.length) { alert("Оберіть документи для завантаження."); return; }
  
      const form = new FormData();
      form.append("doc_ids", ids.join(","));
      form.append("client_id", "{{ selected_client.id|default:'' }}");
      form.append("csrfmiddlewaretoken", getCookie("csrftoken"));
  
      const resp = await fetch("{% url 'documents_download_zip' %}", { method: "POST", body: form });
      if (!resp.ok) { alert("Не вдалося завантажити ZIP."); return; }
  
      const cd = resp.headers.get("Content-Disposition");
      const filename = getFilenameFromContentDisposition(cd) || "documents.zip";
  
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
  
      const a = document.createElement("a");
      a.href = url;
      a.download = filename; // ✅ теперь имя берём с сервера
      document.body.appendChild(a);
      a.click();
      a.remove();
  
      URL.revokeObjectURL(url);
    });
  </script>
  
  
{% endblock %}
